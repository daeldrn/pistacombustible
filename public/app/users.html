<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Usuarios - Mi Aplicación</title>

    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700&amp;subset=latin" rel="stylesheet">
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/custom.css" rel="stylesheet" />
    <link href="/css/nifty.css" rel="stylesheet">
    <link href="/plugins/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <link href="/plugins/animate-css/animate.min.css" rel="stylesheet">
    <link href="/css/demo/nifty-demo.css" rel="stylesheet">
    <link href="/plugins/pace/pace.min.css" rel="stylesheet">
    <script src="/plugins/pace/pace.min.js"></script>
</head>

<body>
    <div id="container" class="effect mainnav-lg">

        <!--NAVBAR-->
        <header id="navbar">
            <div id="navbar-container" class="boxed">
                <div class="navbar-header">
                    <a href="/app/dashboard.html" class="navbar-brand">
                        <img src="/img/logo.png" alt="Logo" class="brand-icon">
                        <div class="brand-title">
                            <span class="brand-text">Mi Aplicación</span>
                        </div>
                    </a>
                </div>

                <div class="navbar-content clearfix">
                    <ul class="nav navbar-top-links pull-left">
                        <li class="tgl-menu-btn">
                            <a class="mainnav-toggle" href="javascript:void(0);">
                                <i class="fa fa-navicon fa-lg"></i>
                            </a>
                        </li>
                    </ul>
                    <ul class="nav navbar-top-links pull-right">
                        <li id="dropdown-user" class="dropdown">
                            <a href="#" data-toggle="dropdown" class="dropdown-toggle text-right">
                                <span class="pull-right">
                                    <img class="img-circle img-user media-object" src="/img/av1.png"
                                        alt="Profile Picture">
                                </span>
                                <div class="username hidden-xs" id="userName">Usuario</div>
                            </a>

                            <div class="dropdown-menu dropdown-menu-md dropdown-menu-right panel-default">
                                <ul class="head-list">
                                    <li>
                                        <a href="#"><i class="fa fa-user fa-fw"></i> Perfil</a>
                                    </li>
                                    <li>
                                        <a href="#"><i class="fa fa-cog fa-fw"></i> Configuración</a>
                                    </li>
                                    <li>
                                        <a href="#" id="logoutBtn"><i class="fa fa-sign-out fa-fw"></i> Cerrar
                                            Sesión</a>
                                    </li>
                                </ul>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </header>

        <div class="boxed">
            <div id="content-container">
                <div id="page-title">
                    <h1 class="page-header text-overflow">Gestión de Usuarios</h1>
                </div>

                <div id="page-content">

                    <div class="row">
                        <div class="col-md-12">
                            <div class="panel">
                                <div class="panel-heading">
                                    <div class="panel-control">
                                        <button class="btn btn-primary" data-toggle="modal"
                                            data-target="#createUserModal">
                                            <i class="fa fa-plus"></i> Nuevo Usuario
                                        </button>
                                    </div>
                                    <h3 class="panel-title">Lista de Usuarios</h3>
                                </div>
                                <div class="panel-body">
                                    <table class="table table-striped table-hover">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Nombre</th>
                                                <th>Email</th>
                                                <th>Estado</th>
                                                <th>Fecha Registro</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="usersTable">
                                            <tr>
                                                <td colspan="6" class="text-center">Cargando...</td>
                                            </tr>
                                        </tbody>
                                    </table>

                                    <div class="text-center" id="pagination"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!--MAIN NAVIGATION-->
            <nav id="mainnav-container">
                <div id="mainnav">
                    <div id="mainnav-menu-wrap">
                        <div class="nano">
                            <div class="nano-content">
                                <ul id="mainnav-menu" class="list-group">
                                    <li class="list-header">Navegación</li>

                                    <li>
                                        <a href="/app/dashboard.html">
                                            <i class="fa fa-dashboard"></i>
                                            <span class="menu-title">Dashboard</span>
                                        </a>
                                    </li>

                                    <li class="active-link">
                                        <a href="/app/users.html">
                                            <i class="fa fa-users"></i>
                                            <span class="menu-title">Usuarios</span>
                                        </a>
                                    </li>

                                    <li>
                                        <a href="#">
                                            <i class="fa fa-shopping-cart"></i>
                                            <span class="menu-title">Pedidos</span>
                                        </a>
                                    </li>

                                    <li>
                                        <a href="#">
                                            <i class="fa fa-file-text"></i>
                                            <span class="menu-title">Reportes</span>
                                        </a>
                                    </li>

                                    <li>
                                        <a href="#">
                                            <i class="fa fa-cog"></i>
                                            <span class="menu-title">Configuración</span>
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>
        </div>

        <footer id="footer">
            <div class="hide-fixed pull-right pad-rgt"></div>
            <p class="pad-lft">&#0169; 2026 Mi Aplicación</p>
        </footer>

        <button id="scroll-top" class="btn"><i class="fa fa-chevron-up"></i></button>
    </div>

    <!-- Modal Crear Usuario -->
    <div class="modal fade" id="createUserModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Nuevo Usuario</h4>
                </div>
                <form id="createUserForm">
                    <div class="modal-body">
                        <div class="alert alert-danger" id="createErrorMessage" style="display: none;"></div>

                        <div class="form-group">
                            <label>Nombre</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="form-group">
                            <label>Contraseña</label>
                            <input type="password" class="form-control" name="password" required>
                        </div>
                        <div class="form-group">
                            <label>Confirmar Contraseña</label>
                            <input type="password" class="form-control" name="password_confirmation" required>
                        </div>
                        <div class="form-group">
                            <label class="form-checkbox form-icon">
                                <input type="checkbox" name="activo" checked> Usuario Activo
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/js/jquery-2.1.1.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/plugins/fast-click/fastclick.min.js"></script>
    <script src="/js/nifty.js"></script>
    <script>
        const API_URL = '/pista';
        let currentPage = 1;

        function checkAuth() {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                window.location.href = '/app/login.html';
                return null;
            }
            return token;
        }

        async function fetchAPI(endpoint, options = {}) {
            const token = checkAuth();
            if (!token) return;

            const headers = {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'Authorization': `Bearer ${token}`,
                ...options.headers
            };

            try {
                const response = await fetch(`${API_URL}${endpoint}`, {
                    ...options,
                    headers
                });

                if (response.status === 401) {
                    localStorage.removeItem('auth_token');
                    localStorage.removeItem('user');
                    window.location.href = '/app/login.html';
                    return null;
                }

                return await response.json();
            } catch (error) {
                console.error('Error:', error);
                return null;
            }
        }

        async function loadUsers(page = 1) {
            const data = await fetchAPI(`/users?page=${page}&per_page=10`);

            if (data && data.success) {
                const users = data.data;
                const tbody = document.getElementById('usersTable');

                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">No hay usuarios registrados</td></tr>';
                } else {
                    tbody.innerHTML = users.map(user => `
                        <tr>
                            <td>${user.id}</td>
                            <td>${user.name}</td>
                            <td>${user.email}</td>
                            <td>
                                ${user.activo
                            ? '<span class="label label-success">Activo</span>'
                            : '<span class="label label-danger">Inactivo</span>'}
                            </td>
                            <td>${new Date(user.created_at).toLocaleDateString('es-ES')}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})" title="Eliminar">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }

                // Paginación
                const pagination = data.pagination;
                let paginationHTML = '<ul class="pagination">';

                for (let i = 1; i <= pagination.last_page; i++) {
                    paginationHTML += `<li class="${i === pagination.current_page ? 'active' : ''}">
                        <a href="#" onclick="loadUsers(${i}); return false;">${i}</a>
                    </li>`;
                }

                paginationHTML += '</ul>';
                document.getElementById('pagination').innerHTML = paginationHTML;
            }
        }

        async function deleteUser(id) {
            if (!confirm('¿Está seguro de eliminar este usuario?')) return;

            const data = await fetchAPI(`/users/${id}`, { method: 'DELETE' });

            if (data && data.success) {
                alert('Usuario eliminado exitosamente');
                loadUsers(currentPage);
            } else {
                alert('Error al eliminar usuario');
            }
        }

        document.getElementById('createUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const userData = {
                name: formData.get('name'),
                email: formData.get('email'),
                password: formData.get('password'),
                password_confirmation: formData.get('password_confirmation'),
                activo: formData.get('activo') ? true : false
            };

            const data = await fetchAPI('/users', {
                method: 'POST',
                body: JSON.stringify(userData)
            });

            if (data && data.success) {
                $('#createUserModal').modal('hide');
                e.target.reset();
                alert('Usuario creado exitosamente');
                loadUsers(currentPage);
            } else {
                document.getElementById('createErrorMessage').textContent = data.message || 'Error al crear usuario';
                document.getElementById('createErrorMessage').style.display = 'block';
            }
        });

        function displayUserName() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            if (user.name) {
                document.getElementById('userName').textContent = user.name;
            }
        }

        document.getElementById('logoutBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            await fetchAPI('/logout', { method: 'POST' });
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user');
            window.location.href = '/app/login.html';
        });

        checkAuth();
        displayUserName();
        loadUsers();
    </script>
</body>

</html>