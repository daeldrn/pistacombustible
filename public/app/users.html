<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Usuarios - Mi Aplicación</title>

    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700&amp;subset=latin" rel="stylesheet">
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/custom.css" rel="stylesheet" />
    <link href="/css/nifty.css" rel="stylesheet">
    <link href="/plugins/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <link href="/plugins/animate-css/animate.min.css" rel="stylesheet">
    <link href="/css/demo/nifty-demo.css" rel="stylesheet">
    <link href="/plugins/pace/pace.min.css" rel="stylesheet">
    <script src="/plugins/pace/pace.min.js"></script>
</head>

<body>
    <div id="container" class="effect mainnav-lg">

        <!--NAVBAR-->
        <header id="navbar">
            <div id="navbar-container" class="boxed">
                <div class="navbar-header">
                    <a href="/app/dashboard.html" class="navbar-brand">
                        <img src="/img/logo.png" alt="Logo" class="brand-icon">
                        <div class="brand-title">
                            <span class="brand-text">Mi Aplicación</span>
                        </div>
                    </a>
                </div>

                <div class="navbar-content clearfix">
                    <ul class="nav navbar-top-links pull-left">
                        <li class="tgl-menu-btn">
                            <a class="mainnav-toggle" href="javascript:void(0);">
                                <i class="fa fa-navicon fa-lg"></i>
                            </a>
                        </li>
                    </ul>
                    <ul class="nav navbar-top-links pull-right">
                        <li id="dropdown-user" class="dropdown">
                            <a href="#" data-toggle="dropdown" class="dropdown-toggle text-right">
                                <span class="pull-right">
                                    <img class="img-circle img-user media-object" src="/img/av1.png"
                                        alt="Profile Picture">
                                </span>
                                <div class="username hidden-xs" id="userName">Usuario</div>
                            </a>

                            <div class="dropdown-menu dropdown-menu-md dropdown-menu-right panel-default">
                                <ul class="head-list">
                                    <li>
                                        <a href="#"><i class="fa fa-user fa-fw"></i> Perfil</a>
                                    </li>
                                    <li>
                                        <a href="#"><i class="fa fa-cog fa-fw"></i> Configuración</a>
                                    </li>
                                    <li>
                                        <a href="#" id="logoutBtn"><i class="fa fa-sign-out fa-fw"></i> Cerrar
                                            Sesión</a>
                                    </li>
                                </ul>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </header>

        <div class="boxed">
            <div id="content-container">
                <div id="page-title">
                    <h1 class="page-header text-overflow">Gestión de Usuarios</h1>
                </div>

                <div id="page-content">

                    <div class="row">
                        <div class="col-md-12">
                            <div class="panel">
                                <div class="panel-heading">
                                    <div class="panel-control">
                                        <button class="btn btn-primary" data-toggle="modal"
                                            data-target="#createUserModal">
                                            <i class="fa fa-plus"></i> Nuevo Usuario
                                        </button>
                                    </div>
                                    <h3 class="panel-title">Lista de Usuarios</h3>
                                </div>
                                <div class="panel-body">
                                    <table class="table table-striped table-hover">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Nombre</th>
                                                <th>Email</th>
                                                <th>Roles</th>
                                                <th>Estado</th>
                                                <th>Fecha Registro</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="usersTable">
                                            <tr>
                                                <td colspan="7" class="text-center">Cargando...</td>
                                            </tr>
                                        </tbody>
                                    </table>

                                    <div class="text-center" id="pagination"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!--MAIN NAVIGATION-->
            <nav id="mainnav-container">
                <div id="mainnav">
                    <div id="mainnav-menu-wrap">
                        <div class="nano">
                            <div class="nano-content">
                                <ul id="mainnav-menu" class="list-group">
                                    <li class="list-header">Navegación</li>

                                    <li>
                                        <a href="/app/dashboard.html">
                                            <i class="fa fa-dashboard"></i>
                                            <span class="menu-title">Dashboard</span>
                                        </a>
                                    </li>

                                    <li class="active-link">
                                        <a href="/app/users.html">
                                            <i class="fa fa-users"></i>
                                            <span class="menu-title">Usuarios</span>
                                        </a>
                                    </li>

                                    <li class="list-divider"></li>
                                    <li class="list-header">Administración</li>

                                    <li>
                                        <a href="/app/roles.html">
                                            <i class="fa fa-shield"></i>
                                            <span class="menu-title">Roles</span>
                                        </a>
                                    </li>

                                    <li>
                                        <a href="/app/permissions.html">
                                            <i class="fa fa-key"></i>
                                            <span class="menu-title">Permisos</span>
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>
        </div>

        <footer id="footer">
            <div class="hide-fixed pull-right pad-rgt"></div>
            <p class="pad-lft">&#0169; 2026 Mi Aplicación</p>
        </footer>

        <button id="scroll-top" class="btn"><i class="fa fa-chevron-up"></i></button>
    </div>

    <!-- Modal Crear Usuario -->
    <div class="modal fade" id="createUserModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Nuevo Usuario</h4>
                </div>
                <form id="createUserForm">
                    <div class="modal-body">
                        <div class="alert alert-danger" id="createErrorMessage" style="display: none;"></div>

                        <div class="form-group">
                            <label>Nombre</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="form-group">
                            <label>Contraseña</label>
                            <input type="password" class="form-control" name="password" required>
                        </div>
                        <div class="form-group">
                            <label>Confirmar Contraseña</label>
                            <input type="password" class="form-control" name="password_confirmation" required>
                        </div>
                        <div class="form-group">
                            <label class="form-checkbox form-icon">
                                <input type="checkbox" name="activo" checked> Usuario Activo
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Editar Usuario -->
    <div class="modal fade" id="editUserModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Editar Usuario</h4>
                </div>
                <form id="editUserForm">
                    <input type="hidden" name="user_id" id="editUserId">
                    <div class="modal-body">
                        <div class="alert alert-danger" id="editErrorMessage" style="display: none;"></div>

                        <div class="form-group">
                            <label>Nombre</label>
                            <input type="text" class="form-control" name="name" id="editUserName" required>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" class="form-control" name="email" id="editUserEmail" required>
                        </div>
                        <div class="form-group">
                            <label>Contraseña (dejar en blanco para no cambiar)</label>
                            <input type="password" class="form-control" name="password">
                        </div>
                        <div class="form-group">
                            <label>Confirmar Contraseña</label>
                            <input type="password" class="form-control" name="password_confirmation">
                        </div>
                        <div class="form-group">
                            <label class="form-checkbox form-icon">
                                <input type="checkbox" name="activo" id="editUserActivo"> Usuario Activo
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Actualizar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Asignar Roles -->
    <div class="modal fade" id="assignRolesModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Asignar Roles</h4>
                </div>
                <form id="assignRolesForm">
                    <input type="hidden" name="user_id" id="assignRolesUserId">
                    <div class="modal-body">
                        <div class="alert alert-danger" id="assignRolesErrorMessage" style="display: none;"></div>

                        <p><strong>Usuario:</strong> <span id="assignRolesUserName"></span></p>

                        <div class="form-group">
                            <label>Roles</label>
                            <div id="rolesList">
                                <p class="text-muted">Cargando roles...</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/js/jquery-2.1.1.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/plugins/fast-click/fastclick.min.js"></script>
    <script src="/js/nifty.js"></script>
    <script src="/js/app-common.js"></script>
    <script>
        let currentPage = 1;
        let allRoles = [];

        async function loadUsers(page = 1) {
            const data = await fetchAPI(`/users?page=${page}&per_page=10`);

            if (data && data.success) {
                const users = data.data;
                const tbody = document.getElementById('usersTable');

                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">No hay usuarios registrados</td></tr>';
                } else {
                    tbody.innerHTML = users.map(user => `
                        <tr>
                            <td>${user.id}</td>
                            <td>${user.name}</td>
                            <td>${user.email}</td>
                            <td>
                                ${user.roles && user.roles.length > 0
                            ? user.roles.map(role => `<span class="label label-primary">${role}</span>`).join(' ')
                            : '<span class="text-muted">Sin rol</span>'}
                            </td>
                            <td>
                                ${user.activo
                            ? '<span class="label label-success">Activo</span>'
                            : '<span class="label label-danger">Inactivo</span>'}
                            </td>
                            <td>${new Date(user.created_at).toLocaleDateString('es-ES')}</td>
                            <td>
                                ${hasPermission('edit users') ? `
                                <button class="btn btn-sm btn-warning" onclick="editUser(${user.id})" title="Editar">
                                    <i class="fa fa-edit"></i>
                                </button>
                                ` : ''}
                                ${hasPermission('assign roles') ? `
                                <button class="btn btn-sm btn-info" onclick="assignRoles(${user.id}, '${user.name}')" title="Asignar Roles">
                                    <i class="fa fa-shield"></i>
                                </button>
                                ` : ''}
                                ${hasPermission('delete users') ? `
                                <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})" title="Eliminar">
                                    <i class="fa fa-trash"></i>
                                </button>
                                ` : ''}
                            </td>
                        </tr>
                    `).join('');
                }

                // Paginación
                const meta = data.meta;
                if (meta && meta.last_page > 1) {
                    let paginationHTML = '<ul class="pagination">';

                    for (let i = 1; i <= meta.last_page; i++) {
                        paginationHTML += `<li class="${i === meta.current_page ? 'active' : ''}">
                            <a href="#" onclick="loadUsers(${i}); return false;">${i}</a>
                        </li>`;
                    }

                    paginationHTML += '</ul>';
                    document.getElementById('pagination').innerHTML = paginationHTML;
                } else {
                    document.getElementById('pagination').innerHTML = '';
                }
            }
        }

        async function loadRoles() {
            const data = await fetchAPI('/roles');
            if (data && data.success) {
                allRoles = data.data;
            }
        }

        async function assignRoles(userId, userName) {
            document.getElementById('assignRolesUserId').value = userId;
            document.getElementById('assignRolesUserName').textContent = userName;

            // Obtener roles actuales del usuario
            const userData = await fetchAPI(`/users/${userId}/permissions`);
            const currentRoles = userData && userData.success
                ? userData.data.roles.map(r => r.name)
                : [];

            // Renderizar lista de roles
            const rolesList = document.getElementById('rolesList');
            rolesList.innerHTML = allRoles.map(role => `
                <div class="checkbox">
                    <label>
                        <input type="checkbox" name="roles[]" value="${role.name}" 
                            ${currentRoles.includes(role.name) ? 'checked' : ''}>
                        ${role.name}
                    </label>
                </div>
            `).join('');

            $('#assignRolesModal').modal('show');
        }

        async function editUser(userId) {
            const data = await fetchAPI(`/users/${userId}`);

            if (data && data.success) {
                const user = data.data;

                // Mostrar el modal primero
                $('#editUserModal').modal('show');

                // Pequeño delay para asegurar que el DOM esté completamente renderizado
                setTimeout(() => {
                    // Resetear el formulario
                    document.getElementById('editUserForm').reset();

                    // Ocultar mensaje de error
                    document.getElementById('editErrorMessage').style.display = 'none';

                    // Establecer los valores
                    document.getElementById('editUserId').value = user.id;
                    document.getElementById('editUserName').value = user.name;
                    document.getElementById('editUserEmail').value = user.email;

                    // Establecer el checkbox y forzar el reflow del DOM
                    const checkbox = document.getElementById('editUserActivo');
                    checkbox.checked = user.activo;

                    // Forzar reflow del DOM
                    void checkbox.offsetWidth;

                    // Disparar evento change para asegurar que Bootstrap actualice el estado visual
                    checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                }, 100);
            }
        }

        document.getElementById('assignRolesForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const userId = formData.get('user_id');
            const roles = Array.from(formData.getAll('roles[]'));

            const data = await fetchAPI(`/users/${userId}/roles`, {
                method: 'POST',
                body: JSON.stringify({ roles })
            });

            if (data && data.success) {
                $('#assignRolesModal').modal('hide');
                showNotification('Roles asignados exitosamente', 'success');
                loadUsers(currentPage);
            } else {
                document.getElementById('assignRolesErrorMessage').textContent = data.message || 'Error al asignar roles';
                document.getElementById('assignRolesErrorMessage').style.display = 'block';
            }
        });

        document.getElementById('editUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const userId = formData.get('user_id');

            const userData = {
                name: formData.get('name'),
                email: formData.get('email'),
                activo: formData.get('activo') ? true : false
            };

            // Solo incluir password si se proporcionó
            const password = formData.get('password');
            if (password) {
                userData.password = password;
                userData.password_confirmation = formData.get('password_confirmation');
            }

            const data = await fetchAPI(`/users/${userId}`, {
                method: 'PUT',
                body: JSON.stringify(userData)
            });

            if (data && data.success) {
                $('#editUserModal').modal('hide');
                showNotification('Usuario actualizado exitosamente', 'success');
                loadUsers(currentPage);
            } else {
                document.getElementById('editErrorMessage').textContent = data.message || 'Error al actualizar usuario';
                document.getElementById('editErrorMessage').style.display = 'block';
            }
        });

        async function deleteUser(id) {
            if (!confirm('¿Está seguro de eliminar este usuario?')) return;

            const data = await fetchAPI(`/users/${id}`, { method: 'DELETE' });

            if (data && data.success) {
                showNotification('Usuario eliminado exitosamente', 'success');
                loadUsers(currentPage);
            } else {
                showNotification('Error al eliminar usuario', 'danger');
            }
        }

        document.getElementById('createUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const userData = {
                name: formData.get('name'),
                email: formData.get('email'),
                password: formData.get('password'),
                password_confirmation: formData.get('password_confirmation'),
                activo: formData.get('activo') ? true : false
            };

            const data = await fetchAPI('/users', {
                method: 'POST',
                body: JSON.stringify(userData)
            });

            if (data && data.success) {
                $('#createUserModal').modal('hide');
                e.target.reset();
                showNotification('Usuario creado exitosamente', 'success');
                loadUsers(currentPage);
            } else {
                document.getElementById('createErrorMessage').textContent = data.message || 'Error al crear usuario';
                document.getElementById('createErrorMessage').style.display = 'block';
            }
        });

        function showNotification(message, type = 'info') {
            const alertClass = `alert-${type}`;
            const alert = $(`
                <div class="alert ${alertClass} alert-dismissible fade in" role="alert" 
                    style="position: fixed; top: 70px; right: 20px; z-index: 9999; min-width: 300px;">
                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                    ${message}
                </div>
            `);

            $('body').append(alert);
            setTimeout(() => alert.alert('close'), 3000);
        }

        checkAuth();
        displayUserName();
        applyMenuPermissions();

        // Verificar permiso para ver usuarios
        if (!hasPermission('view users')) {
            document.getElementById('page-content').innerHTML = `
                <div class="alert alert-danger">
                    <h4><i class="fa fa-ban"></i> Acceso Denegado</h4>
                    <p>No tienes permisos para ver esta página.</p>
                    <a href="/app/dashboard.html" class="btn btn-primary">Volver al Dashboard</a>
                </div>
            `;
        } else {
            loadUsers();
            loadRoles();

            // Ocultar botón de crear si no tiene permiso
            if (!hasPermission('create users')) {
                document.querySelector('[data-target="#createUserModal"]').style.display = 'none';
            }
        }
    </script>
</body>

</html>